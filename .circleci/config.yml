version: 2

executors:
  NodeAndroidDocker:
    docker:
      - image: circleci/android:api-28-node
    working_directory: ~/NativescriptAppBuild

jobs:
  PrepareProject:
    executor: docker
    steps:
      - checkout

      - run:
          name: Install npm modules
          command: |
            sudo npm i -g npm-check-updates nativescript firebase-tools --ignore-scripts --unsafe-perm --no-progress;
            npm i --no-progress;
            tns usage-reporting disable && tns error-reporting disable;

      - run:
          name: Update version in manifest
          command: |
            node ./scripts/update-version.js

      - run:
          name: Build setup
          command: |
            ./UpdateAll.sh;
            echo $ANDROID_KEY_BASE64 | base64 -d > ./key.jks;
            echo $PLAY_STORE_JWT > ./jwt.json;
            rm -rf platforms;
            tns platform add android;
            cp ./app/App_Resources/Android/gradle.properties ./platforms/android/gradle.properties;
      - persist_to_workspace:
            root: workspace
            paths:
                  - echo-output


  BuildReleaseAndroid:
    executor: NodeAndroidDocker
    steps:
      - attach_workspace:
            at: workspace

      - run:
          name: Build signed app
          environment:
            ANDROID_KEY_BASE64: ""
            PLAY_STORE_JWT: ""
          command: |
            tns build android --release --key-store-path ./key.jks --key-store-password "${KEY_STORE_PASSWORD}" --key-store-alias "${KEY_STORE_ALIAS}" --key-store-alias-password "${KEY_STORE_ALIAS_PASSWORD}" --copy-to ./dist/build.apk;

  DistributeAndroid:
    executor: NodeAndroidDocker
    steps:
      - attach_workspace:
            at: workspace
      - run:
          name: Publish apk to firebase app distribution
          command: |
            export GIT_COMMIT_MESSAGE="$(git log --format=%B -n 1 $CIRCLE_SHA1)"
            echo ${APP_DIST_ANDROID_GROUP}|base64;
            echo $GIT_COMMIT_MESSAGE;
            firebase appdistribution:distribute ./dist/build.apk --app ${APP_DIST_ANDROID_ID} --release-notes "$GIT_COMMIT_MESSAGE" --groups ${APP_DIST_ANDROID_GROUP} --token ${FIREBASE_TOOLS_TOKEN}

  BuildReleaseIOS:
    executor: NodeAndroidDocker
    steps:
      - attach_workspace:
            at: workspace
      - run:
          name: Build signed app
          command: |
            tns build ios

#      - run:
#          name: Publish app to internal track on Google Play
#          command: |
#            node ./scripts/upload-package.js

      - store_artifacts:
          path: ./dist

workflows:
  version: 2
  BuildAndDistributeAndroid:
    jobs:
      - PrepareProject
      - BuildReleaseAndroid:
            requires:
                  - PrepareProject
      - DistributeAndroid:
            requires:
                  - BuildReleaseAndroid
  BuildAndDistributeIOS:
    jobs:
      - PrepareProject
      - BuildReleaseIOS:
            requires:
                  - PrepareProject
#          filters:
#            branches:
#              ignore: /.*/
#            tags:
#              only: /.*/
